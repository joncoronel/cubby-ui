{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "combobox",
  "type": "registry:ui",
  "title": "Combobox",
  "description": "A combobox component.",
  "dependencies": [
    "lucide-react"
  ],
  "registryDependencies": [
    "@cubby-ui/label"
  ],
  "files": [
    {
      "path": "registry/default/combobox/combobox.tsx",
      "content": "\"use client\";\r\n\r\nimport * as React from \"react\";\r\n// import * as ComboboxPrimitive from \"@base-ui-components/react/combobox\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { X, CheckIcon, ChevronDown } from \"lucide-react\";\r\nimport { Label } from \"@/registry/default/label/label\";\r\nimport { Combobox as BaseCombobox } from \"@base-ui-components/react/combobox\";\r\n\r\nconst useFilter = BaseCombobox.useFilter;\r\n\r\nconst ComboboxContext = React.createContext<{\r\n  id: string;\r\n  chipsRef: React.RefObject<HTMLDivElement | null>;\r\n} | null>(null);\r\n\r\nfunction Combobox<Value, Multiple extends boolean | undefined = false>(\r\n  props: BaseCombobox.Root.Props<Value, Multiple>,\r\n): React.JSX.Element {\r\n  const id = React.useId();\r\n  const chipsRef = React.useRef<HTMLDivElement | null>(null);\r\n\r\n  const contextValue = React.useMemo(() => ({ id, chipsRef }), [id]);\r\n\r\n  return (\r\n    <ComboboxContext.Provider value={contextValue}>\r\n      <BaseCombobox.Root data-slot=\"combobox\" {...props} />\r\n    </ComboboxContext.Provider>\r\n  );\r\n}\r\n\r\nfunction ComboboxInput({\r\n  id: idProp,\r\n  className,\r\n  ...props\r\n}: BaseCombobox.Input.Props) {\r\n  const context = React.useContext(ComboboxContext);\r\n  const id = idProp ?? context?.id;\r\n\r\n  return (\r\n    <BaseCombobox.Input\r\n      id={id}\r\n      data-slot=\"combobox-input\"\r\n      className={cn(\r\n        \"placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground bg-input dark:bg-input/30 border-border py- flex h-10 w-full min-w-0 rounded-lg border px-3 text-base font-normal shadow-[0_1px_2px_0_oklch(0.18_0_0_/_0.03)] disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-60 sm:h-9 md:text-sm\",\r\n        \"file:text-foreground file:inline-flex file:h-7 file:rounded-md file:border-0 file:bg-transparent file:text-sm file:font-medium\",\r\n        \"focus-visible:outline-ring/50 outline-0 outline-offset-0 outline-transparent transition-[outline-width,outline-offset,outline-color] duration-100 ease-out outline-solid focus-visible:outline-2 focus-visible:outline-offset-2\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxInputWrapper({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"combobox-input-wrapper\"\r\n      className={cn(\r\n        \"relative\",\r\n        // Auto-adjust input padding based on buttons present (right-3 = 0.75rem, button = 1rem)\r\n        \"has-[[data-slot=combobox-clear]]:[&_[data-slot=combobox-input]]:pr-[1.75rem]\",\r\n        \"has-[[data-slot=combobox-trigger]]:[&_[data-slot=combobox-input]]:pr-[1.75rem]\",\r\n        // Both buttons present (0.75rem + 1rem + 0.5rem gap + 1rem button = 3.25rem)\r\n        \"has-[[data-slot=combobox-clear]]:has-[[data-slot=combobox-trigger]]:[&_[data-slot=combobox-input]]:pr-[3.25rem]\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxChipInput({\r\n  id: idProp,\r\n  className,\r\n  ...props\r\n}: BaseCombobox.Input.Props) {\r\n  const context = React.useContext(ComboboxContext);\r\n  const id = idProp ?? context?.id;\r\n\r\n  return (\r\n    <BaseCombobox.Input\r\n      id={id}\r\n      data-slot=\"combobox-input\"\r\n      className={cn(\r\n        \"placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground h-7 min-w-12 flex-1 rounded-none border-none bg-transparent p-0 pl-1.5 text-base font-normal shadow-none outline-none focus-visible:ring-0 focus-visible:ring-offset-0 disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-60 sm:h-6 md:text-sm\",\r\n\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxTrigger({ className, ...props }: BaseCombobox.Trigger.Props) {\r\n  return (\r\n    <BaseCombobox.Trigger\r\n      data-slot=\"combobox-trigger\"\r\n      aria-label=\"Open popup\"\r\n      className={cn(\r\n        \"inline-flex size-4 cursor-pointer items-center justify-center rounded-md border-none bg-transparent p-0 text-sm font-medium transition-colors disabled:pointer-events-none disabled:opacity-60\",\r\n        \"focus-visible:border-ring focus-visible:ring-ring/30 focus-visible:ring-3\",\r\n\r\n        className,\r\n      )}\r\n      {...props}\r\n    >\r\n      <ChevronDown className=\"h-4 w-4\" />\r\n    </BaseCombobox.Trigger>\r\n  );\r\n}\r\n\r\nfunction ComboboxIcon({ className, ...props }: BaseCombobox.Icon.Props) {\r\n  return (\r\n    <BaseCombobox.Icon\r\n      data-slot=\"combobox-icon\"\r\n      className={cn(\"ml-2 h-4 w-4 shrink-0 opacity-50\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxClear({ className, ...props }: BaseCombobox.Clear.Props) {\r\n  return (\r\n    <BaseCombobox.Clear\r\n      data-slot=\"combobox-clear\"\r\n      aria-label=\"Clear selection\"\r\n      className={cn(\r\n        \"inline-flex h-4 w-4 cursor-pointer items-center justify-center rounded-sm opacity-70 transition-[opacity,scale,transform,translate] hover:opacity-100 disabled:pointer-events-none\",\r\n        \"focus-visible:border-ring focus-visible:ring-ring/30 duration-100 outline-none focus-visible:ring-3\",\r\n        \"data-[ending-style]:translate-x-1 data-[ending-style]:opacity-0 data-[starting-style]:translate-x-1 data-[starting-style]:opacity-0\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    >\r\n      <X className=\"h-4 w-4\" />\r\n    </BaseCombobox.Clear>\r\n  );\r\n}\r\n\r\nfunction ComboboxValue({ ...props }: BaseCombobox.Value.Props) {\r\n  return <BaseCombobox.Value data-slot=\"combobox-value\" {...props} />;\r\n}\r\n\r\nfunction ComboboxPortal({ ...props }: BaseCombobox.Portal.Props) {\r\n  return <BaseCombobox.Portal data-slot=\"combobox-portal\" {...props} />;\r\n}\r\n\r\nfunction ComboboxBackdrop({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.Backdrop.Props) {\r\n  return (\r\n    <BaseCombobox.Backdrop\r\n      data-slot=\"combobox-backdrop\"\r\n      className={cn(\r\n        \"fixed inset-0 z-30 bg-black/50 data-[ending-style]:opacity-0 data-[starting-style]:opacity-0\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxPositioner({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.Positioner.Props) {\r\n  return (\r\n    <BaseCombobox.Positioner\r\n      data-slot=\"combobox-positioner\"\r\n      sideOffset={6}\r\n      className={cn(\"\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxPopupPrimitive({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.Popup.Props) {\r\n  return (\r\n    <BaseCombobox.Popup\r\n      data-slot=\"combobox-popup\"\r\n      className={cn(\r\n        \"bg-popover text-popover-foreground outline-border/70 ring-border/50 dark:ring-border ease-out-cubic max-h-[min(var(--available-height),20rem)] w-[var(--anchor-width)] max-w-[var(--available-width)] origin-[var(--transform-origin)] overflow-y-auto overscroll-contain rounded-xl p-1 shadow-[0_8px_20px_0_oklch(0.18_0_0_/_0.10)] ring-1 transition-[transform,scale,opacity] duration-100 data-[ending-style]:scale-95 data-[ending-style]:opacity-0 data-[starting-style]:scale-95 data-[starting-style]:opacity-0\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxArrow({ className, ...props }: BaseCombobox.Arrow.Props) {\r\n  return (\r\n    <BaseCombobox.Arrow\r\n      data-slot=\"combobox-arrow\"\r\n      className={cn(\r\n        \"data-[side=bottom]:top-[-8px] data-[side=left]:right-[-13px] data-[side=left]:rotate-90 data-[side=right]:left-[-13px] data-[side=right]:-rotate-90 data-[side=top]:bottom-[-8px] data-[side=top]:rotate-180\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    >\r\n      <svg width=\"20\" height=\"10\" viewBox=\"0 0 20 10\" fill=\"none\">\r\n        <path\r\n          d=\"M9.66437 2.60207L4.80758 6.97318C4.07308 7.63423 3.11989 8 2.13172 8H0V9H20V8H18.5349C17.5468 8 16.5936 7.63423 15.8591 6.97318L11.0023 2.60207C10.622 2.2598 10.0447 2.25979 9.66437 2.60207Z\"\r\n          className=\"fill-popover\"\r\n        />\r\n        <path\r\n          d=\"M10.3333 3.34539L5.47654 7.71648C4.55842 8.54279 3.36693 9 2.13172 9H0V8H2.13172C3.11989 8 4.07308 7.63423 4.80758 6.97318L9.66437 2.60207C10.0447 2.25979 10.622 2.2598 11.0023 2.60207L15.8591 6.97318C16.5936 7.63423 17.5468 8 18.5349 8H20V9H18.5349C17.2998 9 16.1083 8.54278 15.1901 7.71648L10.3333 3.34539Z\"\r\n          className=\"fill-border/70\"\r\n        />\r\n      </svg>\r\n    </BaseCombobox.Arrow>\r\n  );\r\n}\r\n\r\nfunction ComboboxStatus({ className, ...props }: BaseCombobox.Status.Props) {\r\n  return (\r\n    <BaseCombobox.Status\r\n      data-slot=\"combobox-status\"\r\n      className={cn(\r\n        \"text-muted-foreground px-2 py-1.5 text-sm leading-5 empty:m-0 empty:p-0\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxEmpty({ className, ...props }: BaseCombobox.Empty.Props) {\r\n  return (\r\n    <BaseCombobox.Empty\r\n      data-slot=\"combobox-empty\"\r\n      className={cn(\r\n        \"text-muted-foreground px-2 py-1.5 text-sm empty:m-0 empty:p-0\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxList({ className, ...props }: BaseCombobox.List.Props) {\r\n  return (\r\n    <BaseCombobox.List\r\n      data-slot=\"combobox-list\"\r\n      className={cn(\"\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxCollection({ ...props }: BaseCombobox.Collection.Props) {\r\n  return <BaseCombobox.Collection data-slot=\"combobox-collection\" {...props} />;\r\n}\r\n\r\nfunction ComboboxRow({ className, ...props }: BaseCombobox.Row.Props) {\r\n  return (\r\n    <BaseCombobox.Row\r\n      data-slot=\"combobox-row\"\r\n      className={cn(\"flex\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxItem({\r\n  className,\r\n  children,\r\n  ...props\r\n}: BaseCombobox.Item.Props) {\r\n  return (\r\n    <BaseCombobox.Item\r\n      data-slot=\"combobox-item\"\r\n      className={cn(\r\n        \"data-[highlighted]:bg-accent/50 data-[highlighted]:text-accent-foreground relative grid cursor-default grid-cols-[1fr_1rem] items-center gap-2 rounded-md px-2.5 py-2 pr-2 text-sm outline-none select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-60\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    >\r\n      <div className=\"break-all\">{children}</div>\r\n      <BaseCombobox.ItemIndicator render={<CheckIcon className=\"size-4\" />} />\r\n    </BaseCombobox.Item>\r\n  );\r\n}\r\n\r\nfunction ComboboxItemIndicator({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.ItemIndicator.Props) {\r\n  return (\r\n    <BaseCombobox.ItemIndicator\r\n      data-slot=\"combobox-item-indicator\"\r\n      className={cn(\"\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxGroup({ className, ...props }: BaseCombobox.Group.Props) {\r\n  return (\r\n    <BaseCombobox.Group\r\n      data-slot=\"combobox-group\"\r\n      className={cn(\"text-foreground block\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxGroupLabel({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.GroupLabel.Props) {\r\n  return (\r\n    <BaseCombobox.GroupLabel\r\n      data-slot=\"combobox-group-label\"\r\n      className={cn(\r\n        \"text-muted-foreground bg-popover -mx-1 px-2 py-1.5 pt-2.5 pl-3.5 text-xs font-semibold\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxSeparator({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.Separator.Props) {\r\n  return (\r\n    <BaseCombobox.Separator\r\n      data-slot=\"combobox-separator\"\r\n      className={cn(\"bg-border my-1 h-px\", className)}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxChips({ className, ...props }: BaseCombobox.Chips.Props) {\r\n  const context = React.useContext(ComboboxContext);\r\n\r\n  return (\r\n    <BaseCombobox.Chips\r\n      ref={context?.chipsRef}\r\n      data-slot=\"combobox-chips\"\r\n      className={cn(\r\n        \"bg-input dark:bg-input/30 flex min-h-9 w-full flex-wrap items-center gap-1.5 rounded-lg border px-1.5 py-1.5 shadow-[0_1px_2px_0_oklch(0.18_0_0_/_0.03)]\",\r\n        \"focus-within:outline-ring/50 outline-0 outline-offset-0 outline-transparent transition-[outline-width,outline-offset,outline-color] duration-100 ease-out outline-solid focus-within:outline-2 focus-within:outline-offset-2\",\r\n\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxChip({ className, ...props }: BaseCombobox.Chip.Props) {\r\n  return (\r\n    <BaseCombobox.Chip\r\n      data-slot=\"combobox-chip\"\r\n      className={cn(\r\n        \"bg-accent text-accent-foreground flex items-center gap-1 rounded-sm border px-[calc(--spacing(2)-1px)] py-[calc(--spacing(1)-1px)] text-sm font-medium break-all sm:text-xs\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\nfunction ComboboxChipRemove({\r\n  className,\r\n  ...props\r\n}: BaseCombobox.ChipRemove.Props) {\r\n  return (\r\n    <BaseCombobox.ChipRemove\r\n      data-slot=\"combobox-chip-remove\"\r\n      className={cn(\r\n        \"ml-1 inline-flex h-4 w-4 items-center justify-center rounded-sm opacity-70 transition-opacity hover:opacity-100 disabled:pointer-events-none\",\r\n        \"focus-visible:border-ring focus-visible:ring-ring/30 cursor-pointer outline-none focus-visible:ring-3\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\ninterface ComboboxPopupProps extends BaseCombobox.Popup.Props {\r\n  sideOffset?: BaseCombobox.Positioner.Props[\"sideOffset\"];\r\n  backdrop?: boolean;\r\n}\r\n\r\nfunction ComboboxPopup({\r\n  className,\r\n  children,\r\n  sideOffset = 6,\r\n  backdrop = false,\r\n  ...props\r\n}: ComboboxPopupProps) {\r\n  const context = React.useContext(ComboboxContext);\r\n\r\n  return (\r\n    <ComboboxPortal>\r\n      {backdrop && <ComboboxBackdrop />}\r\n      <ComboboxPositioner anchor={context?.chipsRef} sideOffset={sideOffset}>\r\n        <ComboboxPopupPrimitive className={className} {...props}>\r\n          {children}\r\n        </ComboboxPopupPrimitive>\r\n      </ComboboxPositioner>\r\n    </ComboboxPortal>\r\n  );\r\n}\r\n\r\nfunction ComboboxLabel({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<typeof Label>) {\r\n  const context = React.useContext(ComboboxContext);\r\n\r\n  return <Label htmlFor={context?.id} className={className} {...props} />;\r\n}\r\n\r\nexport {\r\n  Combobox,\r\n  ComboboxInput,\r\n  ComboboxInputWrapper,\r\n  ComboboxChipInput,\r\n  ComboboxTrigger,\r\n  ComboboxIcon,\r\n  ComboboxClear,\r\n  ComboboxValue,\r\n  ComboboxPortal,\r\n  ComboboxBackdrop,\r\n  ComboboxPositioner,\r\n  ComboboxPopupPrimitive,\r\n  ComboboxPopup,\r\n  ComboboxArrow,\r\n  ComboboxStatus,\r\n  ComboboxEmpty,\r\n  ComboboxList,\r\n  ComboboxCollection,\r\n  ComboboxRow,\r\n  ComboboxItem,\r\n  ComboboxItemIndicator,\r\n  ComboboxGroup,\r\n  ComboboxGroupLabel,\r\n  ComboboxSeparator,\r\n  ComboboxChips,\r\n  ComboboxChip,\r\n  ComboboxChipRemove,\r\n  ComboboxLabel,\r\n  useFilter,\r\n};\r\n",
      "type": "registry:ui",
      "target": "components/ui/cubby-ui/combobox.tsx"
    },
    {
      "path": "registry/default/combobox/hooks/use-async-combobox.ts",
      "content": "import * as React from \"react\";\r\n\r\nexport interface UseAsyncComboboxOptions<T extends { id: string }> {\r\n  /**\r\n   * Async search function that receives the query and an AbortSignal.\r\n   * Should return an array of items matching the query.\r\n   */\r\n  searchFn: (query: string, signal: AbortSignal) => Promise<T[]>;\r\n\r\n  /**\r\n   * Debounce delay in milliseconds. Defaults to 0 (no debounce).\r\n   */\r\n  debounceMs?: number;\r\n}\r\n\r\nexport interface UseAsyncComboboxSingleOptions<T extends { id: string }>\r\n  extends UseAsyncComboboxOptions<T> {\r\n  /**\r\n   * Whether multiple selection is enabled\r\n   */\r\n  multiple?: false;\r\n\r\n  /**\r\n   * Controlled selected value\r\n   */\r\n  value?: T | null;\r\n\r\n  /**\r\n   * Callback when value changes\r\n   */\r\n  onValueChange?: (value: T | null) => void;\r\n}\r\n\r\nexport interface UseAsyncComboboxMultipleOptions<T extends { id: string }>\r\n  extends UseAsyncComboboxOptions<T> {\r\n  /**\r\n   * Whether multiple selection is enabled\r\n   */\r\n  multiple: true;\r\n\r\n  /**\r\n   * Controlled selected values\r\n   */\r\n  value?: T[];\r\n\r\n  /**\r\n   * Callback when values change\r\n   */\r\n  onValueChange?: (value: T[]) => void;\r\n}\r\n\r\nexport interface UseAsyncComboboxReturn<T extends { id: string }> {\r\n  /**\r\n   * Items array with search results merged with selected values.\r\n   * Selected values are always kept in the list during search.\r\n   */\r\n  items: T[];\r\n\r\n  /**\r\n   * Props to spread onto the Combobox component\r\n   */\r\n  comboboxProps: {\r\n    inputValue: string;\r\n    onInputValueChange: (\r\n      value: string,\r\n      details: { reason: string; event: Event | React.SyntheticEvent },\r\n    ) => void;\r\n    filter: null;\r\n    onOpenChangeComplete: (open: boolean) => void;\r\n  };\r\n\r\n  /**\r\n   * Whether a search is in progress\r\n   */\r\n  isPending: boolean;\r\n\r\n  /**\r\n   * Error message if the search failed\r\n   */\r\n  error: string | null;\r\n\r\n  /**\r\n   * Trimmed input value for status message logic\r\n   */\r\n  query: string;\r\n}\r\n\r\n/**\r\n * Hook to manage async search combobox state and logic\r\n *\r\n * This hook encapsulates the complex logic needed for async search:\r\n * - AbortController for canceling in-flight requests\r\n * - useTransition for pending states\r\n * - Merging search results with selected values to keep them visible\r\n * - Clearing results when popup closes\r\n *\r\n * @example\r\n * ```tsx\r\n * const [value, setValue] = useState<Employee | null>(null);\r\n *\r\n * const { items, comboboxProps, isPending, error, query } = useAsyncCombobox({\r\n *   searchFn: searchEmployees,\r\n *   value,\r\n *   onValueChange: setValue,\r\n * });\r\n *\r\n * <Combobox items={items} value={value} onValueChange={setValue} {...comboboxProps}>\r\n *   ...\r\n * </Combobox>\r\n * ```\r\n */\r\nexport function useAsyncCombobox<T extends { id: string }>(\r\n  options: UseAsyncComboboxSingleOptions<T>,\r\n): UseAsyncComboboxReturn<T>;\r\nexport function useAsyncCombobox<T extends { id: string }>(\r\n  options: UseAsyncComboboxMultipleOptions<T>,\r\n): UseAsyncComboboxReturn<T>;\r\nexport function useAsyncCombobox<T extends { id: string }>({\r\n  searchFn,\r\n  debounceMs = 0,\r\n  multiple,\r\n  value,\r\n  onValueChange,\r\n}:\r\n  | UseAsyncComboboxSingleOptions<T>\r\n  | UseAsyncComboboxMultipleOptions<T>): UseAsyncComboboxReturn<T> {\r\n  const [searchResults, setSearchResults] = React.useState<T[]>([]);\r\n  const [inputValue, setInputValue] = React.useState(\"\");\r\n  const [error, setError] = React.useState<string | null>(null);\r\n  const [isPending, startTransition] = React.useTransition();\r\n\r\n  const abortControllerRef = React.useRef<AbortController | null>(null);\r\n  const debounceTimerRef = React.useRef<ReturnType<typeof setTimeout> | null>(\r\n    null,\r\n  );\r\n\r\n  const query = inputValue.trim();\r\n\r\n  // Merge search results with selected values to keep them visible\r\n  const items = React.useMemo(() => {\r\n    if (multiple) {\r\n      const selectedValues = (value as T[] | undefined) ?? [];\r\n      if (selectedValues.length === 0) {\r\n        return searchResults;\r\n      }\r\n      // Add selected values that aren't already in search results\r\n      const searchIds = new Set(searchResults.map((item) => item.id));\r\n      const missingSelected = selectedValues.filter(\r\n        (item) => !searchIds.has(item.id),\r\n      );\r\n      return [...searchResults, ...missingSelected];\r\n    } else {\r\n      const selectedValue = value as T | null | undefined;\r\n      if (\r\n        !selectedValue ||\r\n        searchResults.some((item) => item.id === selectedValue.id)\r\n      ) {\r\n        return searchResults;\r\n      }\r\n      return [...searchResults, selectedValue];\r\n    }\r\n  }, [searchResults, value, multiple]);\r\n\r\n  // Perform search\r\n  const performSearch = React.useCallback(\r\n    (searchQuery: string) => {\r\n      // Cancel any previous request\r\n      abortControllerRef.current?.abort();\r\n      const controller = new AbortController();\r\n      abortControllerRef.current = controller;\r\n\r\n      startTransition(async () => {\r\n        setError(null);\r\n\r\n        try {\r\n          const results = await searchFn(searchQuery, controller.signal);\r\n\r\n          if (controller.signal.aborted) {\r\n            return;\r\n          }\r\n\r\n          startTransition(() => {\r\n            setSearchResults(results);\r\n          });\r\n        } catch (err) {\r\n          if (controller.signal.aborted) {\r\n            return;\r\n          }\r\n\r\n          const message =\r\n            err instanceof Error ? err.message : \"Search failed. Try again.\";\r\n          setError(message);\r\n          setSearchResults([]);\r\n        }\r\n      });\r\n    },\r\n    [searchFn],\r\n  );\r\n\r\n  // Handle input value changes\r\n  const handleInputValueChange = React.useCallback(\r\n    (\r\n      nextValue: string,\r\n      details: { reason: string; event: Event | React.SyntheticEvent },\r\n    ) => {\r\n      setInputValue(nextValue);\r\n\r\n      // Don't search if input was cleared due to item selection\r\n      if (details.reason === \"item-press\") {\r\n        return;\r\n      }\r\n\r\n      // Clear debounce timer\r\n      if (debounceTimerRef.current) {\r\n        clearTimeout(debounceTimerRef.current);\r\n        debounceTimerRef.current = null;\r\n      }\r\n\r\n      const trimmed = nextValue.trim();\r\n\r\n      if (trimmed === \"\") {\r\n        setSearchResults([]);\r\n        setError(null);\r\n        abortControllerRef.current?.abort();\r\n        return;\r\n      }\r\n\r\n      // Debounce the search\r\n      if (debounceMs > 0) {\r\n        debounceTimerRef.current = setTimeout(() => {\r\n          performSearch(trimmed);\r\n        }, debounceMs);\r\n      } else {\r\n        performSearch(trimmed);\r\n      }\r\n    },\r\n    [debounceMs, performSearch],\r\n  );\r\n\r\n  // Handle popup close - reset to only show selected values\r\n  const handleOpenChangeComplete = React.useCallback(\r\n    (open: boolean) => {\r\n      if (!open) {\r\n        if (multiple) {\r\n          const selectedValues = (value as T[] | undefined) ?? [];\r\n          setSearchResults(selectedValues);\r\n          // Clear input for multiple selection (chips show the selections)\r\n          setInputValue(\"\");\r\n        } else {\r\n          const selectedValue = value as T | null | undefined;\r\n          setSearchResults(selectedValue ? [selectedValue] : []);\r\n          // Don't clear input for single selection - Base UI handles\r\n          // displaying the selected value via itemToStringLabel\r\n        }\r\n        setError(null);\r\n      }\r\n    },\r\n    [value, multiple],\r\n  );\r\n\r\n  // Cleanup on unmount\r\n  React.useEffect(() => {\r\n    return () => {\r\n      abortControllerRef.current?.abort();\r\n      if (debounceTimerRef.current) {\r\n        clearTimeout(debounceTimerRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    items,\r\n    comboboxProps: {\r\n      inputValue,\r\n      onInputValueChange: handleInputValueChange,\r\n      filter: null,\r\n      onOpenChangeComplete: handleOpenChangeComplete,\r\n    },\r\n    isPending,\r\n    error,\r\n    query,\r\n  };\r\n}\r\n",
      "type": "registry:hook",
      "target": "hooks/cubby-ui/use-async-combobox.ts"
    },
    {
      "path": "registry/default/combobox/hooks/use-creatable-combobox.ts",
      "content": "import * as React from \"react\";\r\n\r\nexport interface UseCreatableComboboxOptions<\r\n  T extends { id: string; value: string },\r\n> {\r\n  /**\r\n   * Controlled items for the combobox\r\n   */\r\n  items: T[];\r\n\r\n  /**\r\n   * Callback when items change\r\n   */\r\n  onItemsChange: (items: T[]) => void;\r\n\r\n  /**\r\n   * Controlled selected items\r\n   */\r\n  selectedItems: T[];\r\n\r\n  /**\r\n   * Callback when selected items change\r\n   */\r\n  onSelectedItemsChange: (items: T[]) => void;\r\n}\r\n\r\nexport interface UseCreatableComboboxReturn<\r\n  T extends { id: string; value: string },\r\n> {\r\n  /**\r\n   * Items array with pseudo \"Create X\" item injected when applicable\r\n   */\r\n  itemsWithCreatable: Array<T & { creatable?: string }>;\r\n\r\n  /**\r\n   * Props to spread onto the Combobox component\r\n   */\r\n  comboboxProps: {\r\n    value: T[];\r\n    onValueChange: (value: unknown) => void;\r\n    inputValue: string;\r\n    onInputValueChange: (value: string) => void;\r\n    onOpenChange: (\r\n      open: boolean,\r\n      details: { event: Event | React.SyntheticEvent },\r\n    ) => void;\r\n  };\r\n\r\n  /**\r\n   * Props to spread onto the Dialog component\r\n   */\r\n  dialogProps: {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n  };\r\n\r\n  /**\r\n   * Props to spread onto the dialog input element\r\n   */\r\n  dialogInputProps: {\r\n    ref: React.RefObject<HTMLInputElement | null>;\r\n    defaultValue: string;\r\n  };\r\n\r\n  /**\r\n   * Form submit handler (handles preventDefault internally)\r\n   */\r\n  onDialogSubmit: (event: React.FormEvent<HTMLFormElement>) => void;\r\n\r\n  /**\r\n   * Dialog cancel handler\r\n   */\r\n  handleCancel: () => void;\r\n}\r\n\r\n/**\r\n * Slugify a string to create a valid ID\r\n */\r\nfunction slugify(value: string): string {\r\n  return value\r\n    .trim()\r\n    .toLowerCase()\r\n    .replace(/\\s+/g, \"-\")\r\n    .replace(/[^\\w-]/g, \"\");\r\n}\r\n\r\n/**\r\n * Generate a unique ID from a value, handling collisions\r\n */\r\nfunction generateUniqueId<T extends { id: string }>(\r\n  value: string,\r\n  existingItems: T[],\r\n): string {\r\n  const baseId = slugify(value);\r\n  const existingIds = new Set(existingItems.map((item) => item.id));\r\n\r\n  let uniqueId = baseId;\r\n  if (existingIds.has(uniqueId)) {\r\n    let counter = 2;\r\n    while (existingIds.has(`${baseId}-${counter}`)) {\r\n      counter += 1;\r\n    }\r\n    uniqueId = `${baseId}-${counter}`;\r\n  }\r\n\r\n  return uniqueId;\r\n}\r\n\r\n/**\r\n * Hook to manage creatable combobox state and logic\r\n *\r\n * This hook encapsulates all the complex logic needed for a creatable combobox:\r\n * - Injecting a pseudo \"Create X\" item when the query doesn't match existing items\r\n * - Handling item creation via a confirmation dialog with automatic ID generation\r\n * - Normalizing values and checking for duplicates\r\n *\r\n * @example\r\n * ```tsx\r\n * const [items, setItems] = useState(initialLabels);\r\n * const [selectedItems, setSelectedItems] = useState<LabelItem[]>([]);\r\n *\r\n * const { itemsWithCreatable, comboboxProps, dialogProps, dialogInputProps, onDialogSubmit, handleCancel } =\r\n *   useCreatableCombobox({\r\n *     items,\r\n *     onItemsChange: setItems,\r\n *     selectedItems,\r\n *     onSelectedItemsChange: setSelectedItems,\r\n *   });\r\n * ```\r\n */\r\nexport function useCreatableCombobox<T extends { id: string; value: string }>({\r\n  items,\r\n  onItemsChange,\r\n  selectedItems,\r\n  onSelectedItemsChange,\r\n}: UseCreatableComboboxOptions<T>): UseCreatableComboboxReturn<T> {\r\n  const [query, setQuery] = React.useState(\"\");\r\n  const [dialogOpen, setDialogOpen] = React.useState(false);\r\n  const [pendingValue, setPendingValue] = React.useState(\"\");\r\n\r\n  const inputRef = React.useRef<HTMLInputElement>(null);\r\n\r\n  // Helper to normalize values for comparison\r\n  const normalize = React.useCallback((value: string) => {\r\n    return value.trim().toLowerCase();\r\n  }, []);\r\n\r\n  // Helper to check if an item already exists\r\n  const itemExists = React.useCallback(\r\n    (value: string) => {\r\n      const normalized = normalize(value);\r\n      return items.some((item) => normalize(item.value) === normalized);\r\n    },\r\n    [items, normalize],\r\n  );\r\n\r\n  // Create the items array with pseudo \"Create X\" item if needed\r\n  const itemsWithCreatable = React.useMemo(() => {\r\n    const trimmed = query.trim();\r\n    if (!trimmed || itemExists(trimmed)) {\r\n      return items;\r\n    }\r\n\r\n    // Add pseudo item\r\n    const normalized = normalize(trimmed);\r\n    return [\r\n      ...items,\r\n      {\r\n        id: `create:${normalized}`,\r\n        value: `Create \"${trimmed}\"`,\r\n        creatable: trimmed,\r\n      } as T & { creatable: string },\r\n    ];\r\n  }, [items, query, itemExists, normalize]);\r\n\r\n  // Handle item creation\r\n  const handleCreate = React.useCallback(() => {\r\n    const value = pendingValue.trim();\r\n    if (!value) return;\r\n\r\n    // Check if item already exists\r\n    if (itemExists(value)) {\r\n      const existing = items.find(\r\n        (item) => normalize(item.value) === normalize(value),\r\n      );\r\n      if (\r\n        existing &&\r\n        !selectedItems.some((item) => item.id === existing.id)\r\n      ) {\r\n        onSelectedItemsChange([...selectedItems, existing]);\r\n      }\r\n      setDialogOpen(false);\r\n      setQuery(\"\");\r\n      setPendingValue(\"\");\r\n      return;\r\n    }\r\n\r\n    // Create new item with auto-generated ID\r\n    const id = generateUniqueId(value, items);\r\n    const newItem = { id, value } as T;\r\n\r\n    onItemsChange([...items, newItem]);\r\n    onSelectedItemsChange([...selectedItems, newItem]);\r\n    setDialogOpen(false);\r\n    setQuery(\"\");\r\n    setPendingValue(\"\");\r\n  }, [\r\n    pendingValue,\r\n    items,\r\n    selectedItems,\r\n    onItemsChange,\r\n    onSelectedItemsChange,\r\n    itemExists,\r\n    normalize,\r\n  ]);\r\n\r\n  // Handle value change from combobox\r\n  const handleValueChange = React.useCallback(\r\n    (value: unknown) => {\r\n      const valueArray = Array.isArray(value) ? value : value ? [value] : [];\r\n      const last = valueArray[valueArray.length - 1];\r\n\r\n      // Check if the last selected item is the pseudo \"Create X\" item\r\n      if (last && \"creatable\" in last && last.creatable) {\r\n        setPendingValue(last.creatable);\r\n        setDialogOpen(true);\r\n        return;\r\n      }\r\n\r\n      // Filter out any pseudo items and update selected\r\n      const cleanValue = valueArray.filter(\r\n        (item) => !(\"creatable\" in item && item.creatable),\r\n      );\r\n      onSelectedItemsChange(cleanValue as T[]);\r\n      setQuery(\"\");\r\n    },\r\n    [onSelectedItemsChange],\r\n  );\r\n\r\n  // Handle combobox open/close - intercept Enter key to open dialog\r\n  const handleOpenChange = React.useCallback(\r\n    (\r\n      open: boolean,\r\n      details: { event: Event | React.SyntheticEvent },\r\n    ) => {\r\n      // Check if Enter key was pressed with a query that doesn't match\r\n      if (\r\n        \"key\" in details.event &&\r\n        (details.event as KeyboardEvent).key === \"Enter\"\r\n      ) {\r\n        const trimmed = query.trim();\r\n        if (!trimmed) return;\r\n\r\n        // Check if item exists\r\n        if (itemExists(trimmed)) {\r\n          const existing = items.find(\r\n            (item) => normalize(item.value) === normalize(trimmed),\r\n          );\r\n          if (\r\n            existing &&\r\n            !selectedItems.some((item) => item.id === existing.id)\r\n          ) {\r\n            onSelectedItemsChange([...selectedItems, existing]);\r\n          }\r\n          setQuery(\"\");\r\n          return;\r\n        }\r\n\r\n        // Open dialog for new item creation\r\n        setPendingValue(trimmed);\r\n        setDialogOpen(true);\r\n      }\r\n    },\r\n    [query, items, selectedItems, itemExists, normalize, onSelectedItemsChange],\r\n  );\r\n\r\n  // Dialog submit handler\r\n  const onDialogSubmit = React.useCallback(\r\n    (event: React.FormEvent<HTMLFormElement>) => {\r\n      event.preventDefault();\r\n      handleCreate();\r\n    },\r\n    [handleCreate],\r\n  );\r\n\r\n  // Dialog cancel handler\r\n  const handleCancel = React.useCallback(() => {\r\n    setDialogOpen(false);\r\n    setPendingValue(\"\");\r\n  }, []);\r\n\r\n  return {\r\n    itemsWithCreatable,\r\n    comboboxProps: {\r\n      value: selectedItems,\r\n      onValueChange: handleValueChange,\r\n      inputValue: query,\r\n      onInputValueChange: setQuery,\r\n      onOpenChange: handleOpenChange,\r\n    },\r\n    dialogProps: {\r\n      open: dialogOpen,\r\n      onOpenChange: setDialogOpen,\r\n    },\r\n    dialogInputProps: {\r\n      ref: inputRef,\r\n      defaultValue: pendingValue,\r\n    },\r\n    onDialogSubmit,\r\n    handleCancel,\r\n  };\r\n}\r\n",
      "type": "registry:hook",
      "target": "hooks/cubby-ui/use-creatable-combobox.ts"
    }
  ]
}