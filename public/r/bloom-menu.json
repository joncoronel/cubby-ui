{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "bloom-menu",
  "type": "registry:ui",
  "title": "Bloom Menu",
  "description": "A bloom-menu component.",
  "dependencies": [
    "motion"
  ],
  "files": [
    {
      "path": "registry/default/bloom-menu/bloom-menu.tsx",
      "content": "\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { m, AnimatePresence, useReducedMotion } from \"motion/react\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\ntype Direction = \"top\" | \"bottom\" | \"left\" | \"right\";\r\ntype Anchor = \"start\" | \"center\" | \"end\";\r\n\r\ntype BloomMenuContextValue = {\r\n  open: boolean;\r\n  setOpen: (open: boolean) => void;\r\n  direction: Direction;\r\n  anchor: Anchor;\r\n  activeSubmenu: string | null;\r\n  setActiveSubmenu: (id: string | null) => void;\r\n  triggerRef: React.RefObject<HTMLDivElement | null>;\r\n  contentRef: React.RefObject<HTMLDivElement | null>;\r\n  isOpenAnimationCompleteRef: React.MutableRefObject<boolean>;\r\n  reducedMotion: boolean;\r\n  visualDuration: number;\r\n  bounce: number;\r\n  // Keyboard navigation\r\n  registerItem: (id: string, ref: HTMLDivElement) => void;\r\n  unregisterItem: (id: string) => void;\r\n  focusedItemId: string | null;\r\n  setFocusedItemId: (id: string | null) => void;\r\n  focusNextItem: () => void;\r\n  focusPrevItem: () => void;\r\n};\r\n\r\ntype SubMenuContextValue = {\r\n  id: string;\r\n  triggerRef: React.RefObject<HTMLDivElement | null>;\r\n};\r\n\r\n// =============================================================================\r\n// Contexts\r\n// =============================================================================\r\n\r\nconst BloomMenuContext = React.createContext<BloomMenuContextValue | null>(\r\n  null,\r\n);\r\n\r\nconst SubMenuContext = React.createContext<SubMenuContextValue | null>(null);\r\n\r\nfunction useBloomMenu() {\r\n  const context = React.useContext(BloomMenuContext);\r\n  if (!context) {\r\n    throw new Error(\"BloomMenu components must be used within BloomMenu\");\r\n  }\r\n  return context;\r\n}\r\n\r\nfunction useSubMenu() {\r\n  const context = React.useContext(SubMenuContext);\r\n  if (!context) {\r\n    throw new Error(\r\n      \"BloomMenuSub components must be used within BloomMenuSub\",\r\n    );\r\n  }\r\n  return context;\r\n}\r\n\r\n// =============================================================================\r\n// Animation Configuration\r\n// =============================================================================\r\n\r\nconst VISUAL_DURATION = 0.25;\r\nconst BOUNCE = 0.2;\r\nconst TRIGGER_BLUR = 8;\r\nconst CONTENT_BLUR = 10;\r\nconst CONTENT_DELAY = 0.03;\r\n\r\nconst reducedMotionSpring = {\r\n  stiffness: 1000,\r\n  damping: 100,\r\n};\r\n\r\n// =============================================================================\r\n// Utility Hooks\r\n// =============================================================================\r\n\r\nfunction useControllable<T>({\r\n  value,\r\n  defaultValue,\r\n  onChange,\r\n}: {\r\n  value?: T;\r\n  defaultValue: T;\r\n  onChange?: (value: T) => void;\r\n}): [T, (value: T) => void] {\r\n  const [internalValue, setInternalValue] = React.useState(defaultValue);\r\n  const isControlled = value !== undefined;\r\n  const currentValue = isControlled ? value : internalValue;\r\n\r\n  const setValue = React.useCallback(\r\n    (newValue: T) => {\r\n      if (!isControlled) {\r\n        setInternalValue(newValue);\r\n      }\r\n      onChange?.(newValue);\r\n    },\r\n    [isControlled, onChange],\r\n  );\r\n\r\n  return [currentValue, setValue];\r\n}\r\n\r\nfunction useClickOutside(\r\n  refs: React.RefObject<HTMLElement | null>[],\r\n  handler: () => void,\r\n  enabled: boolean,\r\n) {\r\n  React.useEffect(() => {\r\n    if (!enabled) return;\r\n\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      const target = event.target as Node;\r\n      const isOutside = refs.every((ref) => !ref.current?.contains(target));\r\n      if (isOutside) {\r\n        handler();\r\n      }\r\n    };\r\n\r\n    // Delay to avoid immediate close from trigger click\r\n    const timeoutId = setTimeout(() => {\r\n      document.addEventListener(\"mousedown\", handleClickOutside, true);\r\n    }, 0);\r\n\r\n    return () => {\r\n      clearTimeout(timeoutId);\r\n      document.removeEventListener(\"mousedown\", handleClickOutside, true);\r\n    };\r\n  }, [refs, handler, enabled]);\r\n}\r\n\r\nfunction useEscapeKey(handler: () => void, enabled: boolean) {\r\n  React.useEffect(() => {\r\n    if (!enabled) return;\r\n\r\n    const handleKeyDown = (event: KeyboardEvent) => {\r\n      if (event.key === \"Escape\") {\r\n        handler();\r\n      }\r\n    };\r\n\r\n    document.addEventListener(\"keydown\", handleKeyDown);\r\n    return () => document.removeEventListener(\"keydown\", handleKeyDown);\r\n  }, [handler, enabled]);\r\n}\r\n\r\n// =============================================================================\r\n// Position Utilities\r\n// =============================================================================\r\n\r\nfunction getPositionStyles(direction: Direction): React.CSSProperties {\r\n  const styles: React.CSSProperties = {\r\n    position: \"absolute\",\r\n  };\r\n\r\n  switch (direction) {\r\n    case \"top\":\r\n      styles.bottom = 0;\r\n      styles.left = 0;\r\n      break;\r\n    case \"bottom\":\r\n      styles.top = 0;\r\n      styles.left = 0;\r\n      break;\r\n    case \"left\":\r\n      styles.right = 0;\r\n      styles.bottom = 0;\r\n      break;\r\n    case \"right\":\r\n      styles.left = 0;\r\n      styles.bottom = 0;\r\n      break;\r\n  }\r\n\r\n  return styles;\r\n}\r\n\r\nfunction getAnchorOffset(\r\n  direction: Direction,\r\n  anchor: Anchor,\r\n  menuWidth: number,\r\n  menuHeight: number,\r\n  buttonWidth: number,\r\n  buttonHeight: number,\r\n) {\r\n  if (anchor === \"start\") {\r\n    return { x: 0, y: 0 };\r\n  }\r\n\r\n  const offsetAmount = anchor === \"center\" ? 0.5 : 1;\r\n\r\n  if (direction === \"top\" || direction === \"bottom\") {\r\n    const xOffset = -(menuWidth - buttonWidth) * offsetAmount;\r\n    return { x: xOffset, y: 0 };\r\n  } else {\r\n    const yOffset = (menuHeight - buttonHeight) * offsetAmount;\r\n    return { x: 0, y: yOffset };\r\n  }\r\n}\r\n\r\nfunction getTransformOrigin(direction: Direction, anchor: Anchor): string {\r\n  const vertical =\r\n    direction === \"top\" ? \"bottom\" : direction === \"bottom\" ? \"top\" : \"center\";\r\n  const horizontal =\r\n    direction === \"left\" ? \"right\" : direction === \"right\" ? \"left\" : \"center\";\r\n\r\n  if (direction === \"top\" || direction === \"bottom\") {\r\n    const h = anchor === \"start\" ? \"left\" : anchor === \"end\" ? \"right\" : \"center\";\r\n    return `${h} ${vertical}`;\r\n  } else {\r\n    const v = anchor === \"start\" ? \"bottom\" : anchor === \"end\" ? \"top\" : \"center\";\r\n    return `${horizontal} ${v}`;\r\n  }\r\n}\r\n\r\nfunction getAnimationOffset(direction: Direction, amount: number) {\r\n  switch (direction) {\r\n    case \"top\":\r\n      return { y: -amount };\r\n    case \"bottom\":\r\n      return { y: amount };\r\n    case \"left\":\r\n      return { x: -amount };\r\n    case \"right\":\r\n      return { x: amount };\r\n  }\r\n}\r\n\r\nfunction getContentOffset(direction: Direction, amount: number) {\r\n  // Content offsets toward trigger origin (opposite of expansion direction)\r\n  switch (direction) {\r\n    case \"top\":\r\n      return { x: 0, y: amount };\r\n    case \"bottom\":\r\n      return { x: 0, y: -amount };\r\n    case \"left\":\r\n      return { x: amount, y: 0 };\r\n    case \"right\":\r\n      return { x: -amount, y: 0 };\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenu (Root)\r\n// =============================================================================\r\n\r\ntype BloomMenuProps = {\r\n  children: React.ReactNode;\r\n  open?: boolean;\r\n  onOpenChange?: (open: boolean) => void;\r\n  defaultOpen?: boolean;\r\n  direction?: Direction;\r\n  anchor?: Anchor;\r\n  closeOnClickOutside?: boolean;\r\n  closeOnEscape?: boolean;\r\n};\r\n\r\nfunction BloomMenu({\r\n  children,\r\n  open: controlledOpen,\r\n  onOpenChange,\r\n  defaultOpen = false,\r\n  direction = \"bottom\",\r\n  anchor: anchorProp = \"start\",\r\n  closeOnClickOutside = true,\r\n  closeOnEscape = true,\r\n}: BloomMenuProps) {\r\n  // For horizontal directions, anchor is always center\r\n  const anchor =\r\n    direction === \"left\" || direction === \"right\" ? \"center\" : anchorProp;\r\n\r\n  const [open, setOpen] = useControllable({\r\n    value: controlledOpen,\r\n    defaultValue: defaultOpen,\r\n    onChange: onOpenChange,\r\n  });\r\n\r\n  const reducedMotion = useReducedMotion() ?? false;\r\n  const triggerRef = React.useRef<HTMLDivElement>(null);\r\n  const contentRef = React.useRef<HTMLDivElement>(null);\r\n  const isOpenAnimationCompleteRef = React.useRef(false);\r\n\r\n  const [activeSubmenu, setActiveSubmenu] = React.useState<string | null>(null);\r\n\r\n  // Keyboard navigation state\r\n  const [focusedItemId, setFocusedItemId] = React.useState<string | null>(null);\r\n  const itemsRef = React.useRef<Map<string, HTMLDivElement>>(new Map());\r\n  const itemOrderRef = React.useRef<string[]>([]);\r\n\r\n  const registerItem = React.useCallback(\r\n    (id: string, ref: HTMLDivElement) => {\r\n      itemsRef.current.set(id, ref);\r\n      if (!itemOrderRef.current.includes(id)) {\r\n        itemOrderRef.current.push(id);\r\n      }\r\n    },\r\n    [],\r\n  );\r\n\r\n  const unregisterItem = React.useCallback((id: string) => {\r\n    itemsRef.current.delete(id);\r\n    itemOrderRef.current = itemOrderRef.current.filter((i) => i !== id);\r\n  }, []);\r\n\r\n  const focusNextItem = React.useCallback(() => {\r\n    const items = itemOrderRef.current;\r\n    if (items.length === 0) return;\r\n\r\n    const currentIndex = focusedItemId ? items.indexOf(focusedItemId) : -1;\r\n    const nextIndex = (currentIndex + 1) % items.length;\r\n    const nextId = items[nextIndex];\r\n    setFocusedItemId(nextId);\r\n    itemsRef.current.get(nextId)?.focus();\r\n  }, [focusedItemId]);\r\n\r\n  const focusPrevItem = React.useCallback(() => {\r\n    const items = itemOrderRef.current;\r\n    if (items.length === 0) return;\r\n\r\n    const currentIndex = focusedItemId ? items.indexOf(focusedItemId) : 0;\r\n    const prevIndex = (currentIndex - 1 + items.length) % items.length;\r\n    const prevId = items[prevIndex];\r\n    setFocusedItemId(prevId);\r\n    itemsRef.current.get(prevId)?.focus();\r\n  }, [focusedItemId]);\r\n\r\n  // Wrapper to reset animation state when menu opens/closes\r\n  const handleSetOpen = React.useCallback(\r\n    (newOpen: boolean) => {\r\n      if (newOpen) {\r\n        isOpenAnimationCompleteRef.current = false;\r\n        setFocusedItemId(null);\r\n        // Reset item order for fresh registration\r\n        itemOrderRef.current = [];\r\n      } else {\r\n        setActiveSubmenu(null);\r\n      }\r\n      setOpen(newOpen);\r\n    },\r\n    [setOpen],\r\n  );\r\n\r\n  // Close on click outside\r\n  useClickOutside(\r\n    [triggerRef, contentRef],\r\n    () => handleSetOpen(false),\r\n    open && closeOnClickOutside,\r\n  );\r\n\r\n  // Close on escape\r\n  useEscapeKey(() => handleSetOpen(false), open && closeOnEscape);\r\n\r\n  const contextValue = React.useMemo(\r\n    () => ({\r\n      open,\r\n      setOpen: handleSetOpen,\r\n      direction,\r\n      anchor,\r\n      activeSubmenu,\r\n      setActiveSubmenu,\r\n      triggerRef,\r\n      contentRef,\r\n      isOpenAnimationCompleteRef,\r\n      reducedMotion,\r\n      visualDuration: VISUAL_DURATION,\r\n      bounce: BOUNCE,\r\n      registerItem,\r\n      unregisterItem,\r\n      focusedItemId,\r\n      setFocusedItemId,\r\n      focusNextItem,\r\n      focusPrevItem,\r\n    }),\r\n    [\r\n      open,\r\n      handleSetOpen,\r\n      direction,\r\n      anchor,\r\n      activeSubmenu,\r\n      reducedMotion,\r\n      registerItem,\r\n      unregisterItem,\r\n      focusedItemId,\r\n      focusNextItem,\r\n      focusPrevItem,\r\n    ],\r\n  );\r\n\r\n  return (\r\n    <BloomMenuContext.Provider value={contextValue}>\r\n      {children}\r\n    </BloomMenuContext.Provider>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuContainer\r\n// =============================================================================\r\n\r\ntype BloomMenuContainerProps = {\r\n  children: React.ReactNode;\r\n  buttonSize?: number | { width: number; height: number };\r\n  menuWidth?: number;\r\n  menuRadius?: number;\r\n  buttonRadius?: number;\r\n  className?: string;\r\n  style?: React.CSSProperties;\r\n};\r\n\r\nfunction BloomMenuContainer({\r\n  children,\r\n  buttonSize = 40,\r\n  menuWidth = 200,\r\n  menuRadius = 12,\r\n  buttonRadius,\r\n  className,\r\n  style,\r\n}: BloomMenuContainerProps) {\r\n  const {\r\n    open,\r\n    setOpen,\r\n    direction,\r\n    anchor,\r\n    activeSubmenu,\r\n    reducedMotion,\r\n    visualDuration,\r\n    bounce,\r\n    contentRef,\r\n  } = useBloomMenu();\r\n\r\n  const measureRef = React.useRef<HTMLDivElement>(null);\r\n\r\n  const buttonWidth =\r\n    typeof buttonSize === \"number\" ? buttonSize : buttonSize.width;\r\n  const buttonHeight =\r\n    typeof buttonSize === \"number\" ? buttonSize : buttonSize.height;\r\n  const [measuredHeight, setMeasuredHeight] =\r\n    React.useState<number>(buttonHeight);\r\n\r\n  // Track submenu-related styles\r\n  const [submenuStylesActive, setSubmenuStylesActive] = React.useState(false);\r\n  const wasSubmenuActiveRef = React.useRef(false);\r\n\r\n  // Delay reverting submenu styles until exit animation completes\r\n  React.useEffect(() => {\r\n    if (activeSubmenu) {\r\n      wasSubmenuActiveRef.current = true;\r\n      setSubmenuStylesActive(true);\r\n    } else if (wasSubmenuActiveRef.current) {\r\n      const timeout = setTimeout(() => {\r\n        setSubmenuStylesActive(false);\r\n        wasSubmenuActiveRef.current = false;\r\n      }, visualDuration * 1000);\r\n      return () => clearTimeout(timeout);\r\n    }\r\n  }, [activeSubmenu, visualDuration]);\r\n\r\n  const springConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration, bounce };\r\n\r\n  // Measure content height when open\r\n  React.useLayoutEffect(() => {\r\n    if (open && measureRef.current) {\r\n      const height = measureRef.current.offsetHeight;\r\n      setMeasuredHeight(height);\r\n    }\r\n  }, [open]);\r\n\r\n  const handleClick = React.useCallback(\r\n    (event: React.MouseEvent) => {\r\n      if (!open) {\r\n        event.preventDefault();\r\n        setOpen(true);\r\n      }\r\n    },\r\n    [open, setOpen],\r\n  );\r\n\r\n  // Default to pill shape\r\n  const closedRadius = buttonRadius ?? Math.min(buttonWidth, buttonHeight) / 2;\r\n  const positionStyles = getPositionStyles(direction);\r\n  const transformOrigin = getTransformOrigin(direction, anchor);\r\n\r\n  // Lift amount is 75% of button height\r\n  const liftAmount = buttonHeight * 0.75;\r\n  const directionOffset = getAnimationOffset(direction, liftAmount);\r\n  const anchorOffset = getAnchorOffset(\r\n    direction,\r\n    anchor,\r\n    menuWidth,\r\n    measuredHeight,\r\n    buttonWidth,\r\n    buttonHeight,\r\n  );\r\n\r\n  const openOffset = {\r\n    x: (directionOffset.x || 0) + anchorOffset.x,\r\n    y: (directionOffset.y || 0) + anchorOffset.y,\r\n  };\r\n\r\n  return (\r\n    <div\r\n      data-slot=\"bloom-menu-container\"\r\n      style={{\r\n        position: \"relative\",\r\n        width: buttonWidth,\r\n        height: buttonHeight,\r\n      }}\r\n    >\r\n      <m.div\r\n        ref={contentRef}\r\n        onClick={handleClick}\r\n        initial={false}\r\n        animate={{\r\n          width: open ? menuWidth : buttonWidth,\r\n          height: open ? measuredHeight : buttonHeight,\r\n          borderRadius: open ? menuRadius : closedRadius,\r\n          x: open ? openOffset.x : 0,\r\n          y: open ? openOffset.y : 0,\r\n          scale: activeSubmenu ? 0.96 : 1,\r\n          boxShadow: open\r\n            ? \"0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)\"\r\n            : \"0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)\",\r\n        }}\r\n        transition={springConfig}\r\n        className={cn(\"bg-popover\", className)}\r\n        style={{\r\n          ...positionStyles,\r\n          overflow: submenuStylesActive ? \"visible\" : \"hidden\",\r\n          cursor: open ? \"default\" : \"pointer\",\r\n          transformOrigin: submenuStylesActive ? \"center center\" : transformOrigin,\r\n          zIndex: open ? 50 : \"auto\",\r\n          willChange: \"transform\",\r\n          ...style,\r\n        }}\r\n      >\r\n        <div ref={measureRef}>{children}</div>\r\n      </m.div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuTrigger\r\n// =============================================================================\r\n\r\ntype BloomMenuTriggerProps = {\r\n  children: React.ReactNode;\r\n  className?: string;\r\n  disabled?: boolean;\r\n};\r\n\r\nfunction BloomMenuTrigger({\r\n  children,\r\n  className,\r\n  disabled = false,\r\n}: BloomMenuTriggerProps) {\r\n  const {\r\n    open,\r\n    setOpen,\r\n    triggerRef,\r\n    reducedMotion,\r\n    visualDuration,\r\n    bounce,\r\n    focusNextItem,\r\n  } = useBloomMenu();\r\n\r\n  const springConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration: visualDuration * 0.85, bounce };\r\n\r\n  const handleClick = React.useCallback(\r\n    (event: React.MouseEvent) => {\r\n      if (disabled) return;\r\n      event.preventDefault();\r\n      event.stopPropagation();\r\n      setOpen(!open);\r\n    },\r\n    [disabled, setOpen, open],\r\n  );\r\n\r\n  const handleKeyDown = React.useCallback(\r\n    (event: React.KeyboardEvent) => {\r\n      if (disabled) return;\r\n      if (event.key === \"Enter\" || event.key === \" \") {\r\n        event.preventDefault();\r\n        setOpen(!open);\r\n      }\r\n      if (event.key === \"ArrowDown\" && !open) {\r\n        event.preventDefault();\r\n        setOpen(true);\r\n        // Focus first item after opening\r\n        requestAnimationFrame(() => {\r\n          focusNextItem();\r\n        });\r\n      }\r\n    },\r\n    [disabled, setOpen, open, focusNextItem],\r\n  );\r\n\r\n  const triggerVariants = {\r\n    visible: {\r\n      opacity: 1,\r\n      filter: \"blur(0px)\",\r\n    },\r\n    hidden: {\r\n      opacity: 0,\r\n      filter: reducedMotion ? \"blur(0px)\" : `blur(${TRIGGER_BLUR}px)`,\r\n    },\r\n  };\r\n\r\n  return (\r\n    <AnimatePresence initial={false}>\r\n      {!open && (\r\n        <m.div\r\n          ref={triggerRef}\r\n          key=\"bloom-trigger\"\r\n          data-slot=\"bloom-menu-trigger\"\r\n          layout={false}\r\n          initial=\"hidden\"\r\n          animate=\"visible\"\r\n          exit=\"hidden\"\r\n          variants={triggerVariants}\r\n          transition={springConfig}\r\n          onClick={handleClick}\r\n          onKeyDown={handleKeyDown}\r\n          role=\"button\"\r\n          tabIndex={disabled ? -1 : 0}\r\n          aria-expanded={open}\r\n          aria-haspopup=\"menu\"\r\n          aria-disabled={disabled || undefined}\r\n          className={className}\r\n          style={{\r\n            position: \"absolute\",\r\n            inset: 0,\r\n            display: \"flex\",\r\n            alignItems: \"center\",\r\n            justifyContent: \"center\",\r\n            cursor: disabled ? \"not-allowed\" : \"pointer\",\r\n          }}\r\n        >\r\n          {children}\r\n        </m.div>\r\n      )}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuContent\r\n// =============================================================================\r\n\r\ntype BloomMenuContentProps = {\r\n  children: React.ReactNode;\r\n  className?: string;\r\n};\r\n\r\nfunction BloomMenuContent({ children, className }: BloomMenuContentProps) {\r\n  const {\r\n    open,\r\n    direction,\r\n    reducedMotion,\r\n    visualDuration,\r\n    bounce,\r\n    isOpenAnimationCompleteRef,\r\n    focusNextItem,\r\n    focusPrevItem,\r\n  } = useBloomMenu();\r\n\r\n  const springConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration: visualDuration * 0.85, bounce };\r\n\r\n  const hiddenOffset = getContentOffset(direction, 8);\r\n  const exitOffset = getContentOffset(direction, 30);\r\n\r\n  const contentVariants = {\r\n    visible: {\r\n      opacity: 1,\r\n      scale: 1,\r\n      x: 0,\r\n      y: 0,\r\n      filter: \"blur(0px)\",\r\n      transition: {\r\n        ...springConfig,\r\n        delay: reducedMotion ? 0 : CONTENT_DELAY,\r\n      },\r\n    },\r\n    hidden: {\r\n      opacity: 0,\r\n      scale: 0.95,\r\n      ...hiddenOffset,\r\n      filter: reducedMotion ? \"blur(0px)\" : `blur(${CONTENT_BLUR}px)`,\r\n    },\r\n    exit: {\r\n      opacity: 0,\r\n      scale: 0.9,\r\n      ...exitOffset,\r\n      filter: reducedMotion ? \"blur(0px)\" : `blur(${CONTENT_BLUR}px)`,\r\n      transition: {\r\n        duration: 0.2,\r\n        ease: [0.4, 0, 1, 1],\r\n      },\r\n    },\r\n  };\r\n\r\n  const handleAnimationComplete = React.useCallback(\r\n    (definition: string) => {\r\n      if (definition === \"visible\") {\r\n        isOpenAnimationCompleteRef.current = true;\r\n      }\r\n    },\r\n    [isOpenAnimationCompleteRef],\r\n  );\r\n\r\n  const handleKeyDown = React.useCallback(\r\n    (event: React.KeyboardEvent) => {\r\n      if (event.key === \"ArrowDown\") {\r\n        event.preventDefault();\r\n        focusNextItem();\r\n      } else if (event.key === \"ArrowUp\") {\r\n        event.preventDefault();\r\n        focusPrevItem();\r\n      }\r\n    },\r\n    [focusNextItem, focusPrevItem],\r\n  );\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      {open && (\r\n        <m.div\r\n          key=\"bloom-content\"\r\n          data-slot=\"bloom-menu-content\"\r\n          role=\"menu\"\r\n          initial=\"hidden\"\r\n          animate=\"visible\"\r\n          exit=\"exit\"\r\n          variants={contentVariants}\r\n          transition={{\r\n            ...springConfig,\r\n            delay: reducedMotion ? 0 : CONTENT_DELAY,\r\n          }}\r\n          onAnimationComplete={handleAnimationComplete}\r\n          onKeyDown={handleKeyDown}\r\n          className={cn(\"text-popover-foreground\", className)}\r\n          style={{ position: \"relative\" }}\r\n        >\r\n          {children}\r\n        </m.div>\r\n      )}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuItem\r\n// =============================================================================\r\n\r\ntype BloomMenuItemProps = {\r\n  children: React.ReactNode;\r\n  onSelect?: () => void;\r\n  disabled?: boolean;\r\n  closeOnSelect?: boolean;\r\n  variant?: \"default\" | \"destructive\";\r\n  className?: string;\r\n};\r\n\r\nfunction BloomMenuItem({\r\n  children,\r\n  onSelect,\r\n  disabled = false,\r\n  closeOnSelect = true,\r\n  variant = \"default\",\r\n  className,\r\n}: BloomMenuItemProps) {\r\n  const {\r\n    setOpen,\r\n    isOpenAnimationCompleteRef,\r\n    activeSubmenu,\r\n    reducedMotion,\r\n    visualDuration,\r\n    bounce,\r\n    registerItem,\r\n    unregisterItem,\r\n    focusedItemId,\r\n    setFocusedItemId,\r\n  } = useBloomMenu();\r\n\r\n  const subMenuContext = React.useContext(SubMenuContext);\r\n  const [isHovered, setIsHovered] = React.useState(false);\r\n  const itemRef = React.useRef<HTMLDivElement>(null);\r\n  const itemId = React.useId();\r\n\r\n  // Register item for keyboard navigation\r\n  React.useEffect(() => {\r\n    if (itemRef.current && !disabled) {\r\n      registerItem(itemId, itemRef.current);\r\n    }\r\n    return () => unregisterItem(itemId);\r\n  }, [itemId, disabled, registerItem, unregisterItem]);\r\n\r\n  // Only dim if there's an active submenu AND this item is NOT inside that submenu\r\n  const isInsideActiveSubmenu = subMenuContext && activeSubmenu === subMenuContext.id;\r\n  const shouldDim = activeSubmenu !== null && !isInsideActiveSubmenu;\r\n\r\n  const springConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration, bounce };\r\n\r\n  const handleClick = React.useCallback(\r\n    (event: React.MouseEvent) => {\r\n      if (disabled) return;\r\n      event.preventDefault();\r\n      onSelect?.();\r\n      if (closeOnSelect) {\r\n        setOpen(false);\r\n      }\r\n    },\r\n    [disabled, onSelect, closeOnSelect, setOpen],\r\n  );\r\n\r\n  const handleKeyDown = React.useCallback(\r\n    (event: React.KeyboardEvent) => {\r\n      if (disabled) return;\r\n      if (event.key === \"Enter\" || event.key === \" \") {\r\n        event.preventDefault();\r\n        onSelect?.();\r\n        if (closeOnSelect) {\r\n          setOpen(false);\r\n        }\r\n      }\r\n    },\r\n    [disabled, onSelect, closeOnSelect, setOpen],\r\n  );\r\n\r\n  const handleMouseEnter = React.useCallback(() => {\r\n    if (!isOpenAnimationCompleteRef.current) return;\r\n    if (!disabled) {\r\n      setIsHovered(true);\r\n      setFocusedItemId(itemId);\r\n    }\r\n  }, [disabled, isOpenAnimationCompleteRef, setFocusedItemId, itemId]);\r\n\r\n  const handleMouseLeave = React.useCallback(() => {\r\n    setIsHovered(false);\r\n  }, []);\r\n\r\n  const handleFocus = React.useCallback(() => {\r\n    setFocusedItemId(itemId);\r\n    setIsHovered(true);\r\n  }, [setFocusedItemId, itemId]);\r\n\r\n  const handleBlur = React.useCallback(() => {\r\n    setIsHovered(false);\r\n  }, []);\r\n\r\n  const isFocused = focusedItemId === itemId;\r\n\r\n  return (\r\n    <m.div\r\n      ref={itemRef}\r\n      data-slot=\"bloom-menu-item\"\r\n      role=\"menuitem\"\r\n      tabIndex={disabled ? -1 : 0}\r\n      aria-disabled={disabled || undefined}\r\n      data-disabled={disabled || undefined}\r\n      data-highlighted={(isHovered || isFocused) || undefined}\r\n      data-variant={variant}\r\n      onClick={handleClick}\r\n      onKeyDown={handleKeyDown}\r\n      onMouseEnter={handleMouseEnter}\r\n      onMouseLeave={handleMouseLeave}\r\n      onFocus={handleFocus}\r\n      onBlur={handleBlur}\r\n      animate={{\r\n        opacity: shouldDim ? 0.5 : 1,\r\n      }}\r\n      transition={springConfig}\r\n      className={cn(\r\n        \"relative flex cursor-default items-center gap-2 rounded-md px-2.5 py-1.5 text-sm outline-hidden select-none\",\r\n        \"data-highlighted:bg-accent/50 data-highlighted:text-accent-foreground\",\r\n        \"data-disabled:pointer-events-none data-disabled:opacity-50\",\r\n        \"data-[variant=destructive]:text-destructive data-[variant=destructive]:data-highlighted:bg-destructive/20\",\r\n        \"[&_svg:not([class*='text-'])]:text-muted-foreground [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4\",\r\n        className,\r\n      )}\r\n      style={{\r\n        cursor: disabled ? \"not-allowed\" : \"pointer\",\r\n        transformOrigin: \"center center\",\r\n        userSelect: \"none\",\r\n      }}\r\n    >\r\n      {children}\r\n    </m.div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuSeparator\r\n// =============================================================================\r\n\r\ntype BloomMenuSeparatorProps = {\r\n  className?: string;\r\n};\r\n\r\nfunction BloomMenuSeparator({ className }: BloomMenuSeparatorProps) {\r\n  return (\r\n    <div\r\n      data-slot=\"bloom-menu-separator\"\r\n      role=\"separator\"\r\n      className={cn(\"bg-border -mx-1 my-1 h-px\", className)}\r\n    />\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuSub\r\n// =============================================================================\r\n\r\ntype BloomMenuSubProps = {\r\n  children: React.ReactNode;\r\n  id: string;\r\n};\r\n\r\nfunction BloomMenuSub({ children, id }: BloomMenuSubProps) {\r\n  const triggerRef = React.useRef<HTMLDivElement>(null);\r\n\r\n  const contextValue = React.useMemo(() => ({ id, triggerRef }), [id]);\r\n\r\n  return (\r\n    <SubMenuContext.Provider value={contextValue}>\r\n      {children}\r\n    </SubMenuContext.Provider>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuSubTrigger\r\n// =============================================================================\r\n\r\ntype BloomMenuSubTriggerProps = {\r\n  children: React.ReactNode | ((isActive: boolean) => React.ReactNode);\r\n  className?: string;\r\n  disabled?: boolean;\r\n};\r\n\r\nfunction BloomMenuSubTrigger({\r\n  children,\r\n  className,\r\n  disabled = false,\r\n}: BloomMenuSubTriggerProps) {\r\n  const {\r\n    setActiveSubmenu,\r\n    activeSubmenu,\r\n    reducedMotion,\r\n    visualDuration,\r\n    bounce,\r\n  } = useBloomMenu();\r\n  const { id, triggerRef } = useSubMenu();\r\n\r\n  const isActive = activeSubmenu === id;\r\n\r\n  const springConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration, bounce };\r\n\r\n  // Scale to pop forward to 1.06 visual (Container is at 0.96, so 0.96 * 1.104 â‰ˆ 1.06)\r\n  const openScale = 1.06 / 0.96;\r\n\r\n  // Track elevated state separately to persist during exit animation\r\n  const [isElevated, setIsElevated] = React.useState(false);\r\n  const wasActiveRef = React.useRef(false);\r\n\r\n  React.useEffect(() => {\r\n    if (isActive) {\r\n      wasActiveRef.current = true;\r\n      setIsElevated(true);\r\n    } else if (wasActiveRef.current) {\r\n      const timeout = setTimeout(() => {\r\n        setIsElevated(false);\r\n        wasActiveRef.current = false;\r\n      }, visualDuration * 1000);\r\n      return () => clearTimeout(timeout);\r\n    }\r\n  }, [isActive, visualDuration]);\r\n\r\n  const handleClick = React.useCallback(\r\n    (event: React.MouseEvent) => {\r\n      event.preventDefault();\r\n      event.stopPropagation();\r\n      if (!disabled) {\r\n        setActiveSubmenu(isActive ? null : id);\r\n      }\r\n    },\r\n    [disabled, setActiveSubmenu, id, isActive],\r\n  );\r\n\r\n  const handleKeyDown = React.useCallback(\r\n    (event: React.KeyboardEvent) => {\r\n      if (disabled) return;\r\n      if (event.key === \"Enter\" || event.key === \" \") {\r\n        event.preventDefault();\r\n        setActiveSubmenu(isActive ? null : id);\r\n      } else if (event.key === \"ArrowRight\" && !isActive) {\r\n        event.preventDefault();\r\n        setActiveSubmenu(id);\r\n      } else if ((event.key === \"ArrowLeft\" || event.key === \"Escape\") && isActive) {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        setActiveSubmenu(null);\r\n      }\r\n    },\r\n    [disabled, setActiveSubmenu, id, isActive],\r\n  );\r\n\r\n  const content = typeof children === \"function\" ? children(isActive) : children;\r\n\r\n  return (\r\n    <m.div\r\n      ref={triggerRef}\r\n      data-slot=\"bloom-menu-sub-trigger\"\r\n      role=\"menuitem\"\r\n      aria-haspopup=\"menu\"\r\n      aria-expanded={isActive}\r\n      aria-disabled={disabled || undefined}\r\n      tabIndex={disabled ? -1 : 0}\r\n      data-active={isActive || undefined}\r\n      data-elevated={isElevated || undefined}\r\n      className={cn(\r\n        \"relative flex cursor-default items-center gap-2 rounded-md px-2.5 py-1.5 text-sm outline-hidden select-none\",\r\n        \"data-highlighted:bg-accent/50 data-highlighted:text-accent-foreground\",\r\n        \"data-disabled:pointer-events-none data-disabled:opacity-50\",\r\n        \"[&_svg:not([class*='text-'])]:text-muted-foreground [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4\",\r\n        className,\r\n      )}\r\n      initial={false}\r\n      animate={{\r\n        scale: isActive ? openScale : 1,\r\n      }}\r\n      transition={springConfig}\r\n      style={{\r\n        position: \"relative\",\r\n        zIndex: isElevated ? 20 : undefined,\r\n        transformOrigin: \"top center\",\r\n        userSelect: \"none\",\r\n        cursor: disabled ? \"not-allowed\" : \"pointer\",\r\n      }}\r\n      onClick={handleClick}\r\n      onKeyDown={handleKeyDown}\r\n    >\r\n      {content}\r\n    </m.div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuSubContent\r\n// =============================================================================\r\n\r\ntype BloomMenuSubContentProps = {\r\n  children: React.ReactNode;\r\n  className?: string;\r\n};\r\n\r\nfunction BloomMenuSubContent({\r\n  children,\r\n  className,\r\n}: BloomMenuSubContentProps) {\r\n  const {\r\n    activeSubmenu,\r\n    setActiveSubmenu,\r\n    contentRef: mainContentRef,\r\n    reducedMotion,\r\n    visualDuration,\r\n    bounce,\r\n  } = useBloomMenu();\r\n  const { id, triggerRef } = useSubMenu();\r\n\r\n  const subMenuRef = React.useRef<HTMLDivElement>(null);\r\n  const measureRef = React.useRef<HTMLDivElement>(null);\r\n\r\n  const [triggerTop, setTriggerTop] = React.useState(0);\r\n  const [triggerHeight, setTriggerHeight] = React.useState(44);\r\n  const [contentHeight, setContentHeight] = React.useState(triggerHeight);\r\n\r\n  const isActive = activeSubmenu === id;\r\n\r\n  // Measure trigger dimensions when submenu opens\r\n  React.useLayoutEffect(() => {\r\n    if (isActive && triggerRef.current) {\r\n      setTriggerTop(triggerRef.current.offsetTop);\r\n      setTriggerHeight(triggerRef.current.offsetHeight);\r\n    }\r\n  }, [isActive, triggerRef]);\r\n\r\n  // Measure content height\r\n  React.useLayoutEffect(() => {\r\n    if (isActive && measureRef.current) {\r\n      setContentHeight(measureRef.current.offsetHeight);\r\n    }\r\n  }, [isActive, children, triggerHeight]);\r\n\r\n  // Handle click outside to close submenu (but not main menu)\r\n  React.useEffect(() => {\r\n    if (!isActive) return;\r\n\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      const target = event.target as Node;\r\n\r\n      if (subMenuRef.current?.contains(target)) {\r\n        return;\r\n      }\r\n\r\n      if (triggerRef.current?.contains(target)) {\r\n        return;\r\n      }\r\n\r\n      if (mainContentRef.current?.contains(target)) {\r\n        event.stopPropagation();\r\n        setActiveSubmenu(null);\r\n        return;\r\n      }\r\n\r\n      setActiveSubmenu(null);\r\n    };\r\n\r\n    const timeoutId = setTimeout(() => {\r\n      document.addEventListener(\"mousedown\", handleClickOutside, true);\r\n    }, 0);\r\n\r\n    return () => {\r\n      clearTimeout(timeoutId);\r\n      document.removeEventListener(\"mousedown\", handleClickOutside, true);\r\n    };\r\n  }, [isActive, setActiveSubmenu, mainContentRef, triggerRef]);\r\n\r\n  const springConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration, bounce };\r\n\r\n  const contentSpringConfig = reducedMotion\r\n    ? { type: \"spring\" as const, ...reducedMotionSpring }\r\n    : { type: \"spring\" as const, visualDuration: visualDuration * 0.85, bounce };\r\n\r\n  const contentVariants = {\r\n    hidden: {\r\n      opacity: 0,\r\n      filter: reducedMotion ? \"blur(0px)\" : `blur(${CONTENT_BLUR}px)`,\r\n    },\r\n    visible: {\r\n      opacity: 1,\r\n      filter: \"blur(0px)\",\r\n      transition: {\r\n        ...contentSpringConfig,\r\n        delay: 0.05,\r\n      },\r\n    },\r\n    exit: {\r\n      opacity: 0,\r\n      filter: reducedMotion ? \"blur(0px)\" : `blur(${CONTENT_BLUR}px)`,\r\n      transition: {\r\n        duration: 0.15,\r\n      },\r\n    },\r\n  };\r\n\r\n  const openScale = 1.06 / 0.96;\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      {isActive && (\r\n        <m.div\r\n          ref={subMenuRef}\r\n          data-slot=\"bloom-menu-sub-content\"\r\n          className={cn(\"bg-popover text-popover-foreground\", className)}\r\n          initial={{\r\n            height: triggerHeight,\r\n            scale: 1,\r\n            opacity: 1,\r\n            pointerEvents: \"auto\" as const,\r\n          }}\r\n          animate={{\r\n            height: contentHeight,\r\n            scale: openScale,\r\n            opacity: 1,\r\n            pointerEvents: \"auto\" as const,\r\n          }}\r\n          exit={{\r\n            height: triggerHeight,\r\n            scale: 1,\r\n            opacity: 0,\r\n            pointerEvents: \"none\" as const,\r\n          }}\r\n          transition={{\r\n            height: springConfig,\r\n            scale: springConfig,\r\n            opacity: { duration: 0.15 },\r\n          }}\r\n          style={{\r\n            position: \"absolute\",\r\n            top: triggerTop,\r\n            left: 0,\r\n            right: 0,\r\n            zIndex: 10,\r\n            overflow: \"hidden\",\r\n            transformOrigin: \"top center\",\r\n            willChange: \"transform, height, opacity\",\r\n            boxSizing: \"content-box\",\r\n          }}\r\n        >\r\n          <div ref={measureRef}>\r\n            {/* Spacer for trigger */}\r\n            <div style={{ height: triggerHeight }} aria-hidden=\"true\" />\r\n\r\n            {/* Content with fade-in */}\r\n            <m.div\r\n              initial=\"hidden\"\r\n              animate=\"visible\"\r\n              exit=\"exit\"\r\n              variants={contentVariants}\r\n            >\r\n              {children}\r\n            </m.div>\r\n          </div>\r\n        </m.div>\r\n      )}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuLabel\r\n// =============================================================================\r\n\r\ntype BloomMenuLabelProps = React.ComponentProps<\"div\"> & {\r\n  inset?: boolean;\r\n};\r\n\r\nfunction BloomMenuLabel({ className, inset, ...props }: BloomMenuLabelProps) {\r\n  return (\r\n    <div\r\n      data-slot=\"bloom-menu-label\"\r\n      data-inset={inset}\r\n      className={cn(\r\n        \"px-2.5 py-1.5 text-xs font-medium data-[inset]:pl-8\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// BloomMenuShortcut\r\n// =============================================================================\r\n\r\ntype BloomMenuShortcutProps = React.ComponentProps<\"span\">;\r\n\r\nfunction BloomMenuShortcut({ className, ...props }: BloomMenuShortcutProps) {\r\n  return (\r\n    <span\r\n      data-slot=\"bloom-menu-shortcut\"\r\n      className={cn(\r\n        \"text-muted-foreground ml-auto text-xs tracking-widest\",\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Exports\r\n// =============================================================================\r\n\r\nexport {\r\n  BloomMenu,\r\n  BloomMenuContainer,\r\n  BloomMenuTrigger,\r\n  BloomMenuContent,\r\n  BloomMenuItem,\r\n  BloomMenuSeparator,\r\n  BloomMenuSub,\r\n  BloomMenuSubTrigger,\r\n  BloomMenuSubContent,\r\n  BloomMenuLabel,\r\n  BloomMenuShortcut,\r\n};\r\n",
      "type": "registry:ui",
      "target": "components/ui/cubby-ui/bloom-menu.tsx"
    }
  ]
}